using System.Collections.Immutable;
using System.Text;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using Microsoft.CodeAnalysis.Text;
using EntityFramework.SourceGenerator.Extensions;

namespace EntityFramework.SourceGenerator.Generators;

[Generator]
public class RelationPropertyGenerator : IIncrementalGenerator
{
    private const string AttributeFileName = "RelationIdAttribute.g.cs";
    private const string Version = "1.0.0";
    private const string GeneratedFileName = "Relations.g.cs";

    private const string AttributeName = "RelationId";
    private const string AttributeFullName = $"{AttributeName}Attribute";
    private const string PropertyName = "RelationType";
    private const string PkPropertyName = "PrimaryKeyName";
    
    private const string AttributeContent = $$"""
                                                    // <auto-generated/>
                                                             
                                                    namespace {{SourceGenerationHelper.AttributesNamespace}}
                                                    {
                                                        [System.AttributeUsage(System.AttributeTargets.Field)]
                                                        public sealed class {{AttributeFullName}} : System.Attribute
                                                        {
                                                            public required System.Type {{PropertyName}} { get; init; }
                                                            
                                                            public string? {{PkPropertyName}} { get; init; }
                                                        }
                                                    }
                                                    """;
    
    private static SymbolDisplayFormat _format = new SymbolDisplayFormat(
        globalNamespaceStyle: SymbolDisplayGlobalNamespaceStyle.Included,
        typeQualificationStyle: SymbolDisplayTypeQualificationStyle.NameAndContainingTypesAndNamespaces);
    
    public void Initialize(IncrementalGeneratorInitializationContext context)
    {
        context.RegisterPostInitializationOutput(ctx => ctx.AddSource(
            AttributeFileName,
            SourceText.From(AttributeContent, Encoding.UTF8)));
        
        IncrementalValuesProvider<FieldDeclarationSyntax> fieldDeclarations = context.SyntaxProvider.CreateSyntaxProvider(
            predicate: static (s, _) => SourceGenerationHelper.IsSyntaxTargetFieldWithAttribute(s, AttributeName),
            transform: static (ctx, _) => SourceGenerationHelper.GetTargetFieldForGeneration(ctx));
        
        IncrementalValueProvider<(Compilation, ImmutableArray<FieldDeclarationSyntax>)> compilationAndFields = 
            context.CompilationProvider.Combine(fieldDeclarations.Collect());
        
        context.RegisterSourceOutput(
            compilationAndFields,
            (spc, source) => Execute(source.Item1, source.Item2, spc));
    }

    private void Execute(Compilation compilation, ImmutableArray<FieldDeclarationSyntax> fields, SourceProductionContext context)
    {
        var builder = new StringBuilder();
        builder.Append("// <auto-generated/>");

        IEnumerable<IGrouping<ClassDeclarationSyntax?, FieldDeclarationSyntax>> fieldsGroupedByClasses = 
            fields.GroupBy(x => x.Parent as ClassDeclarationSyntax);

        foreach (var group in fieldsGroupedByClasses)
        {
            if (group.Key is null) continue;
            
            SemanticModel semanticModel = compilation.GetSemanticModel(group.Key.SyntaxTree);
            ISymbol symbol = semanticModel.GetDeclaredSymbol(group.Key)!;

            builder.Append($$"""
                              
                              namespace {{symbol.ContainingNamespace?.ToDisplayString() ?? string.Empty}}
                              {
                                  partial class {{symbol.Name}}
                                  {
                              """);
            
            foreach (var field in group)
            {
                IFieldSymbol? fieldSymbol = semanticModel.GetDeclaredSymbol(field.Declaration.Variables.First()) as IFieldSymbol;
                if (fieldSymbol is null) continue;

                AttributeData? attribute = fieldSymbol
                    .GetAttributes()
                    .FirstOrDefault(x => x.AttributeClass?.Name == AttributeFullName);
                
                if (attribute is null) continue;

                ITypeSymbol propertyTypeSymbol = (attribute
                    .NamedArguments.
                    FirstOrDefault(x => x.Key == PropertyName)
                    .Value.Value! as ITypeSymbol)!;
                
                string propertyTypeName = propertyTypeSymbol.Name;
                string propertyTypeFullName = propertyTypeSymbol.ToDisplayString(_format);
                
                string? pkName = attribute
                    .NamedArguments.
                    FirstOrDefault(x => x.Key == PkPropertyName)
                    .Value.Value?.ToString() ?? "Id";

                string fieldName = fieldSymbol.Name;
                string idPropertyName = propertyTypeName + pkName;
                
                string idTypeName = fieldSymbol.Type.ToDisplayString(_format);

                builder.Append($$"""
                                 
                                         public {{idTypeName}} {{idPropertyName}}
                                         { 
                                             get => {{fieldName}}; 
                                             set => {{fieldName}} = value;
                                         }
                                         
                                         public virtual {{propertyTypeFullName}} {{propertyTypeName}} { get; set; }
                                 """);
            }

            builder.Append("""
                           
                               }
                           }
                           """);
        }
        
        context.AddSource(GeneratedFileName, SourceText.From(builder.ToString(), Encoding.UTF8));
    }
}